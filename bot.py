import os
import requests
from telegram import Update, Bot
from telegram.ext import Updater, CommandHandler, CallbackContext
from datetime import datetime
# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
TELEGRAM_TOKEN = os.environ.get('TG_TOKEN')
# –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è Render (—É–¥–∞–ª–∏—Ç–µ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
if not TELEGRAM_TOKEN:
    TELEGRAM_TOKEN = "8250242729:AAEkH3O9ZJftDj1wtG84lckLB2VVnd3bgNs"  # –≤–∞—à —Ç–æ–∫–µ–Ω
    print("‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–∫–µ–Ω –∏–∑ –∫–æ–¥–∞!")
    
if not TELEGRAM_TOKEN:
    raise ValueError("–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –£–∫–∞–∂–∏—Ç–µ TG_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.")

NBRB_API_URL = "https://api.nbrb.by/exrates/rates/USD?parammode=2"

def get_currency_rate():
    try:
        response = requests.get(NBRB_API_URL)
        response.raise_for_status()
        data = response.json()
        rate = data['Cur_OfficialRate']
        date_str = datetime.now().strftime("%d.%m.%Y %H:%M")
        return f"üá∫üá∏ –ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ –ù–ë–†–ë\n–Ω–∞ {date_str}:\n\n1 USD = {rate} BYN"
    except Exception as e:
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {str(e)}"

def start_command(update: Update, context: CallbackContext):
    user = update.effective_user
    welcome_msg = f"–ü—Ä–∏–≤–µ—Ç, {user.first_name}! üëã\n–Ø –±–æ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫—É—Ä—Å–∞ –¥–æ–ª–ª–∞—Ä–∞ –æ—Ç –ù–∞—Ü–±–∞–Ω–∫–∞ –†–ë.\n\n"
    welcome_msg += "–ü—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏ /rate —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫—É—Ä—Å"
    context.bot.send_message(chat_id=update.effective_chat.id, text=welcome_msg)
    rate_msg = get_currency_rate()
    context.bot.send_message(chat_id=update.effective_chat.id, text=rate_msg)

def rate_command(update: Update, context: CallbackContext):
    rate_msg = get_currency_rate()
    context.bot.send_message(chat_id=update.effective_chat.id, text=rate_msg)

def main():
    print("üü¢ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç 24/7")
    updater = Updater(token=TELEGRAM_TOKEN)
    dispatcher = updater.dispatcher
    
    dispatcher.add_handler(CommandHandler("start", start_command))
    dispatcher.add_handler(CommandHandler("rate", rate_command))
    
    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
